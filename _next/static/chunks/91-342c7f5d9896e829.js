"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[91],{7020:function(e,t,a){a.d(t,{Dn:function(){return f},I$:function(){return L},Oy:function(){return y},Tz:function(){return g},ZU:function(){return v},nf:function(){return c}});var r=a(1542);let n=null;async function i(){return n||(n=await (0,r.X3)("phonics-cost-optimization",1,{upgrade(e){if(!e.objectStoreNames.contains("pronunciationCache")){let t=e.createObjectStore("pronunciationCache",{keyPath:"word"});t.createIndex("by-word","word"),t.createIndex("by-date","cachedAt")}e.objectStoreNames.contains("rateLimit")||e.createObjectStore("rateLimit",{keyPath:"oderId"})}}))}function o(e,t){return"".concat(e.toLowerCase(),"_").concat(t.toLowerCase()).replace(/\s+/g,"_")}async function s(e,t,a){try{let r=await i(),n=o(e,t);await r.put("pronunciationCache",{word:n,transcript:t,result:a,cachedAt:Date.now()})}catch(e){console.error("발음 캐시 저장 실패:",e)}}async function l(e,t){try{let a=await i(),r=o(e,t),n=await a.get("pronunciationCache",r);if(!n)return null;if(Date.now()-n.cachedAt>2592e6)return await a.delete("pronunciationCache",r),null;return n.result}catch(e){return console.error("발음 캐시 조회 실패:",e),null}}function u(e,t){let a=e.toLowerCase().trim(),r=t.toLowerCase().trim();if(a===r)return 1;if(0===a.length||0===r.length)return 0;let n=a.length,i=r.length,o=[];for(let e=0;e<=n;e++)o[e]=[e];for(let e=0;e<=i;e++)o[0][e]=e;for(let e=1;e<=n;e++)for(let t=1;t<=i;t++){let n=a[e-1]===r[t-1]?0:1;o[e][t]=Math.min(o[e-1][t]+1,o[e][t-1]+1,o[e-1][t-1]+n)}return 1-o[n][i]/Math.max(n,i)}function c(e,t){let a;let r=.4*u(e,t)+.6*function(e,t){let a=e.toLowerCase(),r=t.toLowerCase();for(let[e,t]of[[/ph/gi,"f"],[/ck/gi,"k"],[/gh/gi,""],[/wr/gi,"r"],[/kn/gi,"n"],[/ee/gi,"i"],[/oo/gi,"u"],[/th/gi,"d"],[/sh/gi,"s"],[/ch/gi,"c"]])a=a.replace(e,t),r=r.replace(e,t);return u(a,r)}(e,t);return a=r>=.95?"완벽해요! 정말 잘했어요! \uD83C\uDF89":r>=.85?"아주 잘했어요! \uD83D\uDC4F":r>=.7?"잘하고 있어요! 조금만 더 연습해봐요! \uD83D\uDCAA":r>=.5?"거의 맞았어요! 다시 한번 들어보고 따라해볼까요? \uD83C\uDFA7":"한 번 더 천천히 따라해볼까요? \uD83C\uDFA4",{transcript:t,confidence:r,isCorrect:r>=.7,feedback:a}}function d(){return new Date().toISOString().split("T")[0]}function p(e){return"".concat(e,"_").concat(d())}async function m(e){try{let t=await i(),a=p(e),r=await t.get("rateLimit",a);return(null==r?void 0:r.count)||0}catch(e){return console.error("Rate limit 조회 실패:",e),0}}async function f(e){let t=await m(e);return{allowed:t<100,remaining:Math.max(0,100-t),limit:100}}async function h(e){try{let t=await i(),a=p(e),r=d(),n=await t.get("rateLimit",a),o=(null==n?void 0:n.count)||0;if(o>=100)return!1;return await t.put("rateLimit",{oderId:a,date:r,count:o+1}),!0}catch(e){return console.error("Rate limit 증가 실패:",e),!1}}class w{set(e,t,a){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:a||this.defaultTTL})}get(e){let t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),null):t.data:null}invalidate(e){this.cache.delete(e)}invalidatePattern(e){let t=new RegExp(e);for(let e of this.cache.keys())t.test(e)&&this.cache.delete(e)}clear(){this.cache.clear()}getStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}constructor(){this.cache=new Map,this.defaultTTL=3e5}}let g=new w,v={userProfile:e=>"user_profile_".concat(e),userStats:e=>"user_stats_".concat(e),classInfo:e=>"class_info_".concat(e),classesByTeacher:e=>"classes_by_teacher_".concat(e),studentsByClass:e=>"students_by_class_".concat(e),allClasses:()=>"all_classes",allUsers:()=>"all_users",pendingTeachers:()=>"pending_teachers"},y={userProfile:3e5,userStats:12e4,classInfo:6e5,studentList:3e5,staticData:18e5};async function L(e,t,a,r){let n=await l(e,t),i=await f(a);if(n)return{result:n,source:"cache",rateLimitInfo:{remaining:i.remaining,limit:i.limit}};if(!function(e,t){let a=u(e,t);return!(a>=.95)&&!(a<.3)}(e,t)){let a=c(e,t);return await s(e,t,a),{result:a,source:"local",rateLimitInfo:{remaining:i.remaining,limit:i.limit}}}if(!i.allowed){let a=c(e,t);return a.feedback="오늘 발음 연습을 많이 했네요! (".concat(i.limit,"회 달성) ").concat(a.feedback),{result:a,source:"local",rateLimitInfo:{remaining:0,limit:i.limit}}}try{await h(a);let n=await r(e,t);await s(e,t,n);let i=await f(a);return{result:n,source:"api",rateLimitInfo:{remaining:i.remaining,limit:i.limit}}}catch(a){return console.error("API 평가 실패, 로컬 평가 사용:",a),{result:c(e,t),source:"local",rateLimitInfo:{remaining:i.remaining-1,limit:i.limit}}}}},6410:function(e,t,a){let r,n,i;a.d(t,{Vv:function(){return c},Xr:function(){return d},vq:function(){return m},yL:function(){return f}});var o=a(738);a(4593);var s=a(5978),l=a(2148);a(6485);let u={apiKey:"AIzaSyCUoIzsX_Fv28uDnVNLkvGXddm_HKOCyuk",authDomain:"iswphonics.firebaseapp.com",projectId:"iswphonics",storageBucket:"iswphonics.firebasestorage.app",messagingSenderId:"528874349490",appId:"1:528874349490:web:2c41b34b4066540fd23aab",measurementId:"G-1VEHD9QYQ4"},c=new l.hJ,d="simssijjang@naver.com";function p(){return r||(r=r=0===(0,o.C6)().length?(0,o.ZF)(u):(0,o.C6)()[0]),r}function m(){return n||(n=(0,s.ad)(p())),n}function f(){return i||(i=(0,l.v0)(p())),i}},9804:function(e,t,a){a.d(t,{$9:function(){return L},Ds:function(){return D},Eq:function(){return U},Ld:function(){return I},Lj:function(){return w},MZ:function(){return v},Ry:function(){return l},Yb:function(){return s},_8:function(){return N},a:function(){return b},aA:function(){return y},c0:function(){return d},et:function(){return f},gj:function(){return S},ni:function(){return c},qH:function(){return A},qj:function(){return u}});var r=a(2148),n=a(5978),i=a(6410),o=a(7020);async function s(e,t,a,n,o){let s=(0,i.yL)();(0,i.vq)();let l=(await (0,r.Xb)(s,e,t)).user;return await (0,r.ck)(l,{displayName:a}),await m(l,n,a,o)}async function l(e,t){let a=(0,i.yL)(),n=await (0,r.e5)(a,e,t),o=await f(n.user.uid);return o||(console.log("사용자 프로필 없음 - 자동 생성 중..."),o=await p(n.user)),await h(o.uid),o}async function u(){let e=(0,i.yL)(),t=await (0,r.rh)(e,i.Vv),a=await f(t.user.uid);return a?await h(a.uid):a=await m(t.user,"student",t.user.displayName||"사용자"),a}async function c(){let e=(0,i.yL)();await (0,r.w7)(e)}async function d(e){let t=(0,i.yL)();await (0,r.LS)(t,e)}async function p(e){var t;let a=(0,i.vq)(),r=e.email===i.Xr,o=null,s={};{let t=localStorage.getItem("pendingSignupRole");if(t){try{let a=JSON.parse(t);a.email===e.email&&(o=a.role,s={schoolName:a.schoolName,displayName:a.displayName})}catch(e){console.error("Failed to parse pending signup:",e)}localStorage.removeItem("pendingSignupRole")}}let l=r?"superAdmin":o||"student",u="teacher"===l?"pending":"approved",c=new Date,d=s.displayName||e.displayName||(null===(t=e.email)||void 0===t?void 0:t.split("@")[0])||"사용자",p={uid:e.uid,email:e.email||"",displayName:d,photoURL:e.photoURL||void 0,role:l,approvalStatus:u,schoolName:s.schoolName,createdAt:c,updatedAt:c,lastLoginAt:c},m={uid:p.uid,email:p.email,displayName:p.displayName,role:p.role,approvalStatus:p.approvalStatus,createdAt:n.EK.fromDate(c),updatedAt:n.EK.fromDate(c),lastLoginAt:n.EK.fromDate(c)};return e.photoURL&&(m.photoURL=e.photoURL),s.schoolName&&(m.schoolName=s.schoolName),await (0,n.pl)((0,n.JU)(a,"users",e.uid),m),"teacher"===l&&await g(e.uid,e.email||"",d,s.schoolName||""),console.log("사용자 프로필 생성 완료: ".concat(e.email,", 역할: ").concat(l)),p}async function m(e,t,a,r){let o=(0,i.vq)(),s=e.email===i.Xr,l=s?"superAdmin":t,u="teacher"===l?"pending":"approved",c=new Date,d={uid:e.uid,email:e.email||"",displayName:a,photoURL:e.photoURL||void 0,role:l,approvalStatus:u,schoolName:null==r?void 0:r.schoolName,classId:null==r?void 0:r.classId,teacherId:null==r?void 0:r.teacherId,studentNumber:null==r?void 0:r.studentNumber,createdAt:c,updatedAt:c,lastLoginAt:c},p={uid:e.uid,email:e.email||"",displayName:a,role:l,approvalStatus:u,createdAt:n.EK.fromDate(c),updatedAt:n.EK.fromDate(c),lastLoginAt:n.EK.fromDate(c)};return e.photoURL&&(p.photoURL=e.photoURL),(null==r?void 0:r.schoolName)&&(p.schoolName=r.schoolName),(null==r?void 0:r.classId)&&(p.classId=r.classId),(null==r?void 0:r.teacherId)&&(p.teacherId=r.teacherId),(null==r?void 0:r.studentNumber)&&(p.studentNumber=r.studentNumber),await (0,n.pl)((0,n.JU)(o,"users",e.uid),p),"teacher"!==t||s||await g(e.uid,e.email||"",a,(null==r?void 0:r.schoolName)||""),d}async function f(e){var t,a,r;let s=o.ZU.userProfile(e),l=o.Tz.get(s);if(l)return l;let u=(0,i.vq)(),c=(0,n.JU)(u,"users",e),d=await (0,n.QT)(c);if(!d.exists())return null;let p=d.data(),m={...p,createdAt:(null===(t=p.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=p.updatedAt)||void 0===a?void 0:a.toDate())||new Date,lastLoginAt:(null===(r=p.lastLoginAt)||void 0===r?void 0:r.toDate())||new Date};return o.Tz.set(s,m,o.Oy.userProfile),m}async function h(e){let t=(0,i.vq)();await (0,n.r7)((0,n.JU)(t,"users",e),{lastLoginAt:n.EK.now()})}async function w(e,t){let a=(0,i.vq)();await (0,n.r7)((0,n.JU)(a,"users",e),{...t,updatedAt:n.EK.now()}),o.Tz.invalidate(o.ZU.userProfile(e))}async function g(e,t,a,r){let o=(0,i.vq)(),s={uid:e,email:t,displayName:a,schoolName:r,requestedAt:new Date,status:"pending"};await (0,n.pl)((0,n.JU)(o,"teacherApprovalRequests",e),{...s,requestedAt:n.EK.now()})}async function v(){let e=(0,i.vq)(),t=(0,n.IO)((0,n.hJ)(e,"teacherApprovalRequests"),(0,n.ar)("status","==","pending"),(0,n.Xo)("requestedAt","desc"));return(await (0,n.PL)(t)).docs.map(e=>{var t,a;let r=e.data();return{...r,requestedAt:(null===(t=r.requestedAt)||void 0===t?void 0:t.toDate())||new Date,reviewedAt:null===(a=r.reviewedAt)||void 0===a?void 0:a.toDate()}})}async function y(e,t){let a=(0,i.vq)(),r=(0,n.qs)(a);r.update((0,n.JU)(a,"users",e),{approvalStatus:"approved",updatedAt:n.EK.now()}),r.update((0,n.JU)(a,"teacherApprovalRequests",e),{status:"approved",reviewedBy:t,reviewedAt:n.EK.now()}),await r.commit()}async function L(e,t,a){let r=(0,i.vq)(),o=(0,n.qs)(r);o.update((0,n.JU)(r,"users",e),{approvalStatus:"rejected",updatedAt:n.EK.now()}),o.update((0,n.JU)(r,"teacherApprovalRequests",e),{status:"rejected",reviewedBy:t,reviewedAt:n.EK.now(),rejectReason:a}),await o.commit()}async function A(e,t,a,r){let o=(0,i.vq)(),s=(0,n.JU)((0,n.hJ)(o,"classes")),l=new Date,u={id:s.id,name:e,grade:r,teacherId:t,teacherName:a,studentIds:[],createdAt:l,updatedAt:l};await (0,n.pl)(s,{...u,createdAt:n.EK.fromDate(l),updatedAt:n.EK.fromDate(l)});let c=(0,n.JU)(o,"users",t),d=await (0,n.QT)(c);if(d.exists()){let e=d.data().classIds||[];await (0,n.r7)(c,{classIds:[...e,s.id],updatedAt:n.EK.now()})}return u}async function D(e){let t=o.ZU.classesByTeacher(e),a=o.Tz.get(t);if(a)return a;let r=(0,i.vq)(),s=(0,n.IO)((0,n.hJ)(r,"classes"),(0,n.ar)("teacherId","==",e)),l=(await (0,n.PL)(s)).docs.map(e=>{var t,a;let r=e.data();return{...r,createdAt:(null===(t=r.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=r.updatedAt)||void 0===a?void 0:a.toDate())||new Date}});return o.Tz.set(t,l,o.Oy.classInfo),l}async function I(){let e=(0,i.vq)();return(await (0,n.PL)((0,n.hJ)(e,"classes"))).docs.map(e=>{var t,a;let r=e.data();return{...r,createdAt:(null===(t=r.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=r.updatedAt)||void 0===a?void 0:a.toDate())||new Date}})}async function S(e,t,a){let o=(0,i.yL)(),s=(0,i.vq)(),l=[];for(let i of a)try{let a="".concat(i.studentNumber,"@phonics.kr"),u=await (0,r.Xb)(o,a,i.password);await (0,r.ck)(u.user,{displayName:i.displayName});let c=new Date,d={uid:u.user.uid,email:a,displayName:i.displayName,role:"student",approvalStatus:"approved",classId:e,teacherId:t,studentNumber:i.studentNumber,createdAt:c,updatedAt:c,lastLoginAt:c};await (0,n.pl)((0,n.JU)(s,"users",u.user.uid),{...d,createdAt:n.EK.fromDate(c),updatedAt:n.EK.fromDate(c),lastLoginAt:n.EK.fromDate(c)}),l.push(u.user.uid)}catch(e){console.error("학생 생성 실패: ".concat(i.displayName),e)}if(l.length>0){let t=(0,n.JU)(s,"classes",e),a=await (0,n.QT)(t);if(a.exists()){let e=a.data();await (0,n.r7)(t,{studentIds:[...e.studentIds||[],...l],updatedAt:n.EK.now()})}}return l}async function N(e){let t=o.ZU.studentsByClass(e),a=o.Tz.get(t);if(a)return a;let r=(0,i.vq)(),s=(0,n.IO)((0,n.hJ)(r,"users"),(0,n.ar)("classId","==",e),(0,n.ar)("role","==","student")),l=(await (0,n.PL)(s)).docs.map(e=>{var t,a,r;let n=e.data();return{...n,createdAt:(null===(t=n.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=n.updatedAt)||void 0===a?void 0:a.toDate())||new Date,lastLoginAt:(null===(r=n.lastLoginAt)||void 0===r?void 0:r.toDate())||new Date}});return o.Tz.set(t,l,o.Oy.studentList),l}async function U(e){let t=(0,i.vq)(),a=(0,n.IO)((0,n.hJ)(t,"users"),(0,n.ar)("role","==",e));return(await (0,n.PL)(a)).docs.map(e=>{var t,a,r;let n=e.data();return{...n,createdAt:(null===(t=n.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=n.updatedAt)||void 0===a?void 0:a.toDate())||new Date,lastLoginAt:(null===(r=n.lastLoginAt)||void 0===r?void 0:r.toDate())||new Date}})}async function b(e){let t=(0,i.vq)(),a=(0,n.IO)((0,n.hJ)(t,"users"),(0,n.ar)("classId","==",e),(0,n.ar)("role","==","student")),r=await (0,n.PL)(a),o=[];for(let a of r.docs){let r=a.data(),i=await (0,n.QT)((0,n.JU)(t,"userStats",a.id));if(i.exists()){var s;let t=i.data();o.push({oderId:a.id,displayName:r.displayName,classId:e,totalXp:t.totalXp||0,level:t.level||1,currentStreak:t.currentStreak||0,longestStreak:t.longestStreak||0,totalWordsLearned:t.totalWordsLearned||0,totalSessionsCompleted:t.totalSessionsCompleted||0,totalTimeSpentMinutes:t.totalTimeSpentMinutes||0,lastStudyDate:(null===(s=t.lastStudyDate)||void 0===s?void 0:s.toDate())||new Date,weeklyProgress:t.weeklyProgress||[]})}else o.push({oderId:a.id,displayName:r.displayName,classId:e,totalXp:0,level:1,currentStreak:0,longestStreak:0,totalWordsLearned:0,totalSessionsCompleted:0,totalTimeSpentMinutes:0,lastStudyDate:new Date,weeklyProgress:[]})}return o}},91:function(e,t,a){a.d(t,{t:function(){return l}});var r=a(9625),n=a(6885),i=a(2148),o=a(6410),s=a(9804);let l=(0,r.Ue)()((0,n.tJ)((e,t)=>({user:null,firebaseUser:null,isLoading:!0,isInitialized:!1,error:null,get isAuthenticated(){return!!t().user},get isSuperAdmin(){var a;return(null===(a=t().user)||void 0===a?void 0:a.role)==="superAdmin"},get isTeacher(){var r;return(null===(r=t().user)||void 0===r?void 0:r.role)==="teacher"},get isStudent(){var n;return(null===(n=t().user)||void 0===n?void 0:n.role)==="student"},get isApproved(){var l;return(null===(l=t().user)||void 0===l?void 0:l.approvalStatus)==="approved"},initialize:async()=>{let t=(0,o.yL)();return new Promise(a=>{(0,i.Aj)(t,async t=>{if(t)try{let a=await (0,s.et)(t.uid);e({firebaseUser:t,user:a,isLoading:!1,isInitialized:!0})}catch(t){console.error("사용자 프로필 로드 실패:",t),e({firebaseUser:null,user:null,isLoading:!1,isInitialized:!0,error:"사용자 정보를 불러오는데 실패했습니다."})}else e({firebaseUser:null,user:null,isLoading:!1,isInitialized:!0});a()})})},signUp:async(t,a,r,n,i)=>{e({isLoading:!0,error:null}),localStorage.setItem("pendingSignupRole",JSON.stringify({email:t,role:n,displayName:r,schoolName:null==i?void 0:i.schoolName}));try{let o=await (0,s.Yb)(t,a,r,n,i);localStorage.removeItem("pendingSignupRole"),e({user:o,isLoading:!1})}catch(a){console.error("SignUp error:",{code:a.code,message:a.message});let t="회원가입에 실패했습니다.";throw"auth/email-already-in-use"===a.code?t="이미 사용 중인 이메일입니다. 로그인을 시도해주세요.":"auth/weak-password"===a.code?t="비밀번호가 너무 약합니다. 6자 이상 입력해주세요.":"auth/invalid-email"===a.code?t="유효하지 않은 이메일 형식입니다.":a.message&&(t=a.message),e({isLoading:!1,error:t}),Error(t)}},signIn:async(t,a)=>{e({isLoading:!0,error:null});try{let r=await (0,s.Ry)(t,a);e({user:r,isLoading:!1})}catch(r){console.error("Firebase Auth Error:",{code:r.code,message:r.message,fullError:r});let t="로그인에 실패했습니다.";"auth/user-not-found"===r.code?t="등록되지 않은 이메일입니다. 회원가입을 먼저 해주세요.":"auth/wrong-password"===r.code||"auth/invalid-credential"===r.code?t="비밀번호가 올바르지 않습니다.":"auth/too-many-requests"===r.code?t="로그인 시도가 너무 많습니다. 잠시 후 다시 시도해주세요.":"auth/invalid-email"===r.code?t="유효하지 않은 이메일 형식입니다.":r.code&&(t="로그인 실패: ".concat(r.code)),e({isLoading:!1,error:t});let a=Error(t);throw a.code=r.code,a}},signInGoogle:async()=>{e({isLoading:!0,error:null});try{let t=await (0,s.qj)();e({user:t,isLoading:!1})}catch(a){let t="Google 로그인에 실패했습니다.";throw"auth/popup-closed-by-user"===a.code&&(t="로그인이 취소되었습니다."),e({isLoading:!1,error:t}),Error(t)}},signOut:async()=>{e({isLoading:!0,error:null});try{await (0,s.ni)(),e({user:null,firebaseUser:null,isLoading:!1})}catch(t){throw e({isLoading:!1,error:"로그아웃에 실패했습니다."}),t}},sendPasswordReset:async t=>{e({isLoading:!0,error:null});try{await (0,s.c0)(t),e({isLoading:!1})}catch(a){let t="비밀번호 재설정 이메일 발송에 실패했습니다.";throw"auth/user-not-found"===a.code&&(t="해당 이메일로 등록된 계정이 없습니다."),e({isLoading:!1,error:t}),Error(t)}},updateProfile:async a=>{let{user:r}=t();if(r){e({isLoading:!0,error:null});try{await (0,s.Lj)(r.uid,a),e({user:{...r,...a},isLoading:!1})}catch(t){throw e({isLoading:!1,error:"프로필 업데이트에 실패했습니다."}),t}}},clearError:()=>{e({error:null})},refreshUser:async()=>{let{user:a}=t();if(a)try{let t=await (0,s.et)(a.uid);t&&e({user:t})}catch(e){console.error("사용자 정보 새로고침 실패:",e)}}}),{name:"phonics-quest-auth",storage:(0,n.FL)(()=>localStorage),partialize:e=>({})}))}}]);