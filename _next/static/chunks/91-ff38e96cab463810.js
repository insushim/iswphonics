"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[91],{6410:function(e,t,a){let r,n,o;a.d(t,{Vv:function(){return l},Xr:function(){return c},vq:function(){return v},yL:function(){return w}});var i=a(738);a(4593);var s=a(5978),d=a(2148);a(6485);let u={apiKey:"AIzaSyCUoIzsX_Fv28uDnVNLkvGXddm_HKOCyuk",authDomain:"iswphonics.firebaseapp.com",projectId:"iswphonics",storageBucket:"iswphonics.firebasestorage.app",messagingSenderId:"528874349490",appId:"1:528874349490:web:2c41b34b4066540fd23aab",measurementId:"G-1VEHD9QYQ4"},l=new d.hJ,c="simssijjang@naver.com";function p(){return r||(r=r=0===(0,i.C6)().length?(0,i.ZF)(u):(0,i.C6)()[0]),r}function v(){return n||(n=(0,s.ad)(p())),n}function w(){return o||(o=(0,d.v0)(p())),o}},9804:function(e,t,a){a.d(t,{$9:function(){return y},Ds:function(){return L},Eq:function(){return q},Ld:function(){return D},Lj:function(){return m},MZ:function(){return f},Ry:function(){return s},Yb:function(){return i},_8:function(){return N},a:function(){return I},aA:function(){return h},c0:function(){return l},et:function(){return v},gj:function(){return S},ni:function(){return u},qH:function(){return A},qj:function(){return d}});var r=a(2148),n=a(5978),o=a(6410);async function i(e,t,a,n,i){let s=(0,o.yL)();(0,o.vq)();let d=(await (0,r.Xb)(s,e,t)).user;return await (0,r.ck)(d,{displayName:a}),await p(d,n,a,i)}async function s(e,t){let a=(0,o.yL)(),n=await (0,r.e5)(a,e,t),i=await v(n.user.uid);return i||(console.log("사용자 프로필 없음 - 자동 생성 중..."),i=await c(n.user)),await w(i.uid),i}async function d(){let e=(0,o.yL)(),t=await (0,r.rh)(e,o.Vv),a=await v(t.user.uid);return a?await w(a.uid):a=await p(t.user,"student",t.user.displayName||"사용자"),a}async function u(){let e=(0,o.yL)();await (0,r.w7)(e)}async function l(e){let t=(0,o.yL)();await (0,r.LS)(t,e)}async function c(e){var t;let a=(0,o.vq)(),r=e.email===o.Xr,i=null,s={};{let t=localStorage.getItem("pendingSignupRole");if(t){try{let a=JSON.parse(t);a.email===e.email&&(i=a.role,s={schoolName:a.schoolName,displayName:a.displayName})}catch(e){console.error("Failed to parse pending signup:",e)}localStorage.removeItem("pendingSignupRole")}}let d=r?"superAdmin":i||"student",u="teacher"===d?"pending":"approved",l=new Date,c=s.displayName||e.displayName||(null===(t=e.email)||void 0===t?void 0:t.split("@")[0])||"사용자",p={uid:e.uid,email:e.email||"",displayName:c,photoURL:e.photoURL||void 0,role:d,approvalStatus:u,schoolName:s.schoolName,createdAt:l,updatedAt:l,lastLoginAt:l},v={uid:p.uid,email:p.email,displayName:p.displayName,role:p.role,approvalStatus:p.approvalStatus,createdAt:n.EK.fromDate(l),updatedAt:n.EK.fromDate(l),lastLoginAt:n.EK.fromDate(l)};return e.photoURL&&(v.photoURL=e.photoURL),s.schoolName&&(v.schoolName=s.schoolName),await (0,n.pl)((0,n.JU)(a,"users",e.uid),v),"teacher"===d&&await g(e.uid,e.email||"",c,s.schoolName||""),console.log("사용자 프로필 생성 완료: ".concat(e.email,", 역할: ").concat(d)),p}async function p(e,t,a,r){let i=(0,o.vq)(),s=e.email===o.Xr,d=s?"superAdmin":t,u=new Date,l={uid:e.uid,email:e.email||"",displayName:a,photoURL:e.photoURL||void 0,role:d,approvalStatus:"teacher"===d?"pending":"approved",schoolName:null==r?void 0:r.schoolName,classId:null==r?void 0:r.classId,teacherId:null==r?void 0:r.teacherId,studentNumber:null==r?void 0:r.studentNumber,createdAt:u,updatedAt:u,lastLoginAt:u};return await (0,n.pl)((0,n.JU)(i,"users",e.uid),{...l,createdAt:n.EK.fromDate(u),updatedAt:n.EK.fromDate(u),lastLoginAt:n.EK.fromDate(u)}),"teacher"!==t||s||await g(e.uid,e.email||"",a,(null==r?void 0:r.schoolName)||""),l}async function v(e){var t,a,r;let i=(0,o.vq)(),s=(0,n.JU)(i,"users",e),d=await (0,n.QT)(s);if(!d.exists())return null;let u=d.data();return{...u,createdAt:(null===(t=u.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=u.updatedAt)||void 0===a?void 0:a.toDate())||new Date,lastLoginAt:(null===(r=u.lastLoginAt)||void 0===r?void 0:r.toDate())||new Date}}async function w(e){let t=(0,o.vq)();await (0,n.r7)((0,n.JU)(t,"users",e),{lastLoginAt:n.EK.now()})}async function m(e,t){let a=(0,o.vq)();await (0,n.r7)((0,n.JU)(a,"users",e),{...t,updatedAt:n.EK.now()})}async function g(e,t,a,r){let i=(0,o.vq)(),s={uid:e,email:t,displayName:a,schoolName:r,requestedAt:new Date,status:"pending"};await (0,n.pl)((0,n.JU)(i,"teacherApprovalRequests",e),{...s,requestedAt:n.EK.now()})}async function f(){let e=(0,o.vq)(),t=(0,n.IO)((0,n.hJ)(e,"teacherApprovalRequests"),(0,n.ar)("status","==","pending"),(0,n.Xo)("requestedAt","desc"));return(await (0,n.PL)(t)).docs.map(e=>{var t,a;let r=e.data();return{...r,requestedAt:(null===(t=r.requestedAt)||void 0===t?void 0:t.toDate())||new Date,reviewedAt:null===(a=r.reviewedAt)||void 0===a?void 0:a.toDate()}})}async function h(e,t){let a=(0,o.vq)(),r=(0,n.qs)(a);r.update((0,n.JU)(a,"users",e),{approvalStatus:"approved",updatedAt:n.EK.now()}),r.update((0,n.JU)(a,"teacherApprovalRequests",e),{status:"approved",reviewedBy:t,reviewedAt:n.EK.now()}),await r.commit()}async function y(e,t,a){let r=(0,o.vq)(),i=(0,n.qs)(r);i.update((0,n.JU)(r,"users",e),{approvalStatus:"rejected",updatedAt:n.EK.now()}),i.update((0,n.JU)(r,"teacherApprovalRequests",e),{status:"rejected",reviewedBy:t,reviewedAt:n.EK.now(),rejectReason:a}),await i.commit()}async function A(e,t,a,r){let i=(0,o.vq)(),s=(0,n.JU)((0,n.hJ)(i,"classes")),d=new Date,u={id:s.id,name:e,grade:r,teacherId:t,teacherName:a,studentIds:[],createdAt:d,updatedAt:d};await (0,n.pl)(s,{...u,createdAt:n.EK.fromDate(d),updatedAt:n.EK.fromDate(d)});let l=(0,n.JU)(i,"users",t),c=await (0,n.QT)(l);if(c.exists()){let e=c.data().classIds||[];await (0,n.r7)(l,{classIds:[...e,s.id],updatedAt:n.EK.now()})}return u}async function L(e){let t=(0,o.vq)(),a=(0,n.IO)((0,n.hJ)(t,"classes"),(0,n.ar)("teacherId","==",e));return(await (0,n.PL)(a)).docs.map(e=>{var t,a;let r=e.data();return{...r,createdAt:(null===(t=r.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=r.updatedAt)||void 0===a?void 0:a.toDate())||new Date}})}async function D(){let e=(0,o.vq)();return(await (0,n.PL)((0,n.hJ)(e,"classes"))).docs.map(e=>{var t,a;let r=e.data();return{...r,createdAt:(null===(t=r.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=r.updatedAt)||void 0===a?void 0:a.toDate())||new Date}})}async function S(e,t,a){let i=(0,o.yL)(),s=(0,o.vq)(),d=[];for(let o of a)try{let a="".concat(o.studentNumber,"@student.iswphonics.com"),u=await (0,r.Xb)(i,a,o.password);await (0,r.ck)(u.user,{displayName:o.displayName});let l=new Date,c={uid:u.user.uid,email:a,displayName:o.displayName,role:"student",approvalStatus:"approved",classId:e,teacherId:t,studentNumber:o.studentNumber,createdAt:l,updatedAt:l,lastLoginAt:l};await (0,n.pl)((0,n.JU)(s,"users",u.user.uid),{...c,createdAt:n.EK.fromDate(l),updatedAt:n.EK.fromDate(l),lastLoginAt:n.EK.fromDate(l)}),d.push(u.user.uid)}catch(e){console.error("학생 생성 실패: ".concat(o.displayName),e)}if(d.length>0){let t=(0,n.JU)(s,"classes",e),a=await (0,n.QT)(t);if(a.exists()){let e=a.data();await (0,n.r7)(t,{studentIds:[...e.studentIds||[],...d],updatedAt:n.EK.now()})}}return d}async function N(e){let t=(0,o.vq)(),a=(0,n.IO)((0,n.hJ)(t,"users"),(0,n.ar)("classId","==",e),(0,n.ar)("role","==","student"));return(await (0,n.PL)(a)).docs.map(e=>{var t,a,r;let n=e.data();return{...n,createdAt:(null===(t=n.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=n.updatedAt)||void 0===a?void 0:a.toDate())||new Date,lastLoginAt:(null===(r=n.lastLoginAt)||void 0===r?void 0:r.toDate())||new Date}})}async function q(e){let t=(0,o.vq)(),a=(0,n.IO)((0,n.hJ)(t,"users"),(0,n.ar)("role","==",e));return(await (0,n.PL)(a)).docs.map(e=>{var t,a,r;let n=e.data();return{...n,createdAt:(null===(t=n.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(a=n.updatedAt)||void 0===a?void 0:a.toDate())||new Date,lastLoginAt:(null===(r=n.lastLoginAt)||void 0===r?void 0:r.toDate())||new Date}})}async function I(e){let t=(0,o.vq)(),a=(0,n.IO)((0,n.hJ)(t,"users"),(0,n.ar)("classId","==",e),(0,n.ar)("role","==","student")),r=await (0,n.PL)(a),i=[];for(let a of r.docs){let r=a.data(),o=await (0,n.QT)((0,n.JU)(t,"userStats",a.id));if(o.exists()){var s;let t=o.data();i.push({oderId:a.id,displayName:r.displayName,classId:e,totalXp:t.totalXp||0,level:t.level||1,currentStreak:t.currentStreak||0,longestStreak:t.longestStreak||0,totalWordsLearned:t.totalWordsLearned||0,totalSessionsCompleted:t.totalSessionsCompleted||0,totalTimeSpentMinutes:t.totalTimeSpentMinutes||0,lastStudyDate:(null===(s=t.lastStudyDate)||void 0===s?void 0:s.toDate())||new Date,weeklyProgress:t.weeklyProgress||[]})}else i.push({oderId:a.id,displayName:r.displayName,classId:e,totalXp:0,level:1,currentStreak:0,longestStreak:0,totalWordsLearned:0,totalSessionsCompleted:0,totalTimeSpentMinutes:0,lastStudyDate:new Date,weeklyProgress:[]})}return i}},91:function(e,t,a){a.d(t,{t:function(){return d}});var r=a(9625),n=a(6885),o=a(2148),i=a(6410),s=a(9804);let d=(0,r.Ue)()((0,n.tJ)((e,t)=>({user:null,firebaseUser:null,isLoading:!0,isInitialized:!1,error:null,get isAuthenticated(){return!!t().user},get isSuperAdmin(){var a;return(null===(a=t().user)||void 0===a?void 0:a.role)==="superAdmin"},get isTeacher(){var r;return(null===(r=t().user)||void 0===r?void 0:r.role)==="teacher"},get isStudent(){var n;return(null===(n=t().user)||void 0===n?void 0:n.role)==="student"},get isApproved(){var d;return(null===(d=t().user)||void 0===d?void 0:d.approvalStatus)==="approved"},initialize:async()=>{let t=(0,i.yL)();return new Promise(a=>{(0,o.Aj)(t,async t=>{if(t)try{let a=await (0,s.et)(t.uid);e({firebaseUser:t,user:a,isLoading:!1,isInitialized:!0})}catch(t){console.error("사용자 프로필 로드 실패:",t),e({firebaseUser:null,user:null,isLoading:!1,isInitialized:!0,error:"사용자 정보를 불러오는데 실패했습니다."})}else e({firebaseUser:null,user:null,isLoading:!1,isInitialized:!0});a()})})},signUp:async(t,a,r,n,o)=>{e({isLoading:!0,error:null}),localStorage.setItem("pendingSignupRole",JSON.stringify({email:t,role:n,displayName:r,schoolName:null==o?void 0:o.schoolName}));try{let i=await (0,s.Yb)(t,a,r,n,o);localStorage.removeItem("pendingSignupRole"),e({user:i,isLoading:!1})}catch(a){console.error("SignUp error:",{code:a.code,message:a.message});let t="회원가입에 실패했습니다.";throw"auth/email-already-in-use"===a.code?t="이미 사용 중인 이메일입니다. 로그인을 시도해주세요.":"auth/weak-password"===a.code?t="비밀번호가 너무 약합니다. 6자 이상 입력해주세요.":"auth/invalid-email"===a.code?t="유효하지 않은 이메일 형식입니다.":a.message&&(t=a.message),e({isLoading:!1,error:t}),Error(t)}},signIn:async(t,a)=>{e({isLoading:!0,error:null});try{let r=await (0,s.Ry)(t,a);e({user:r,isLoading:!1})}catch(r){console.error("Firebase Auth Error:",{code:r.code,message:r.message,fullError:r});let t="로그인에 실패했습니다.";"auth/user-not-found"===r.code?t="등록되지 않은 이메일입니다. 회원가입을 먼저 해주세요.":"auth/wrong-password"===r.code||"auth/invalid-credential"===r.code?t="비밀번호가 올바르지 않습니다.":"auth/too-many-requests"===r.code?t="로그인 시도가 너무 많습니다. 잠시 후 다시 시도해주세요.":"auth/invalid-email"===r.code?t="유효하지 않은 이메일 형식입니다.":r.code&&(t="로그인 실패: ".concat(r.code)),e({isLoading:!1,error:t});let a=Error(t);throw a.code=r.code,a}},signInGoogle:async()=>{e({isLoading:!0,error:null});try{let t=await (0,s.qj)();e({user:t,isLoading:!1})}catch(a){let t="Google 로그인에 실패했습니다.";throw"auth/popup-closed-by-user"===a.code&&(t="로그인이 취소되었습니다."),e({isLoading:!1,error:t}),Error(t)}},signOut:async()=>{e({isLoading:!0,error:null});try{await (0,s.ni)(),e({user:null,firebaseUser:null,isLoading:!1})}catch(t){throw e({isLoading:!1,error:"로그아웃에 실패했습니다."}),t}},sendPasswordReset:async t=>{e({isLoading:!0,error:null});try{await (0,s.c0)(t),e({isLoading:!1})}catch(a){let t="비밀번호 재설정 이메일 발송에 실패했습니다.";throw"auth/user-not-found"===a.code&&(t="해당 이메일로 등록된 계정이 없습니다."),e({isLoading:!1,error:t}),Error(t)}},updateProfile:async a=>{let{user:r}=t();if(r){e({isLoading:!0,error:null});try{await (0,s.Lj)(r.uid,a),e({user:{...r,...a},isLoading:!1})}catch(t){throw e({isLoading:!1,error:"프로필 업데이트에 실패했습니다."}),t}}},clearError:()=>{e({error:null})},refreshUser:async()=>{let{user:a}=t();if(a)try{let t=await (0,s.et)(a.uid);t&&e({user:t})}catch(e){console.error("사용자 정보 새로고침 실패:",e)}}}),{name:"phonics-quest-auth",storage:(0,n.FL)(()=>localStorage),partialize:e=>({})}))}}]);