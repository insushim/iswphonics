"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[91],{6410:function(t,e,a){let r,n,i;a.d(e,{Vv:function(){return l},Xr:function(){return c},vq:function(){return v},yL:function(){return w}});var o=a(738);a(4593);var s=a(5978),u=a(2148);a(6485);let d={apiKey:"AIzaSyCUoIzsX_Fv28uDnVNLkvGXddm_HKOCyuk",authDomain:"iswphonics.firebaseapp.com",projectId:"iswphonics",storageBucket:"iswphonics.firebasestorage.app",messagingSenderId:"528874349490",appId:"1:528874349490:web:2c41b34b4066540fd23aab",measurementId:"G-1VEHD9QYQ4"},l=new u.hJ,c="simssijjang@naver.com";function p(){return r||(r=r=0===(0,o.C6)().length?(0,o.ZF)(d):(0,o.C6)()[0]),r}function v(){return n||(n=(0,s.ad)(p())),n}function w(){return i||(i=(0,u.v0)(p())),i}},9804:function(t,e,a){a.d(e,{$9:function(){return h},Ds:function(){return m},Eq:function(){return I},Ld:function(){return L},Lj:function(){return w},MZ:function(){return y},Ry:function(){return s},Yb:function(){return o},_8:function(){return q},a:function(){return E},aA:function(){return A},c0:function(){return l},et:function(){return p},gj:function(){return D},ni:function(){return d},qH:function(){return g},qj:function(){return u}});var r=a(2148),n=a(5978),i=a(6410);async function o(t,e,a,n,o){let s=(0,i.yL)();(0,i.vq)();let u=(await (0,r.Xb)(s,t,e)).user;return await (0,r.ck)(u,{displayName:a}),await c(u,n,a,o)}async function s(t,e){let a=(0,i.yL)(),n=await (0,r.e5)(a,t,e),o=await p(n.user.uid);if(!o)throw Error("사용자 프로필을 찾을 수 없습니다.");return await v(o.uid),o}async function u(){let t=(0,i.yL)(),e=await (0,r.rh)(t,i.Vv),a=await p(e.user.uid);return a?await v(a.uid):a=await c(e.user,"student",e.user.displayName||"사용자"),a}async function d(){let t=(0,i.yL)();await (0,r.w7)(t)}async function l(t){let e=(0,i.yL)();await (0,r.LS)(e,t)}async function c(t,e,a,r){let o=(0,i.vq)(),s=t.email===i.Xr,u=s?"superAdmin":e,d=new Date,l={uid:t.uid,email:t.email||"",displayName:a,photoURL:t.photoURL||void 0,role:u,approvalStatus:"teacher"===u?"pending":"approved",schoolName:null==r?void 0:r.schoolName,classId:null==r?void 0:r.classId,teacherId:null==r?void 0:r.teacherId,studentNumber:null==r?void 0:r.studentNumber,createdAt:d,updatedAt:d,lastLoginAt:d};return await (0,n.pl)((0,n.JU)(o,"users",t.uid),{...l,createdAt:n.EK.fromDate(d),updatedAt:n.EK.fromDate(d),lastLoginAt:n.EK.fromDate(d)}),"teacher"!==e||s||await f(t.uid,t.email||"",a,(null==r?void 0:r.schoolName)||""),l}async function p(t){var e,a,r;let o=(0,i.vq)(),s=(0,n.JU)(o,"users",t),u=await (0,n.QT)(s);if(!u.exists())return null;let d=u.data();return{...d,createdAt:(null===(e=d.createdAt)||void 0===e?void 0:e.toDate())||new Date,updatedAt:(null===(a=d.updatedAt)||void 0===a?void 0:a.toDate())||new Date,lastLoginAt:(null===(r=d.lastLoginAt)||void 0===r?void 0:r.toDate())||new Date}}async function v(t){let e=(0,i.vq)();await (0,n.r7)((0,n.JU)(e,"users",t),{lastLoginAt:n.EK.now()})}async function w(t,e){let a=(0,i.vq)();await (0,n.r7)((0,n.JU)(a,"users",t),{...e,updatedAt:n.EK.now()})}async function f(t,e,a,r){let o=(0,i.vq)(),s={uid:t,email:e,displayName:a,schoolName:r,requestedAt:new Date,status:"pending"};await (0,n.pl)((0,n.JU)(o,"teacherApprovalRequests",t),{...s,requestedAt:n.EK.now()})}async function y(){let t=(0,i.vq)(),e=(0,n.IO)((0,n.hJ)(t,"teacherApprovalRequests"),(0,n.ar)("status","==","pending"),(0,n.Xo)("requestedAt","desc"));return(await (0,n.PL)(e)).docs.map(t=>{var e,a;let r=t.data();return{...r,requestedAt:(null===(e=r.requestedAt)||void 0===e?void 0:e.toDate())||new Date,reviewedAt:null===(a=r.reviewedAt)||void 0===a?void 0:a.toDate()}})}async function A(t,e){let a=(0,i.vq)(),r=(0,n.qs)(a);r.update((0,n.JU)(a,"users",t),{approvalStatus:"approved",updatedAt:n.EK.now()}),r.update((0,n.JU)(a,"teacherApprovalRequests",t),{status:"approved",reviewedBy:e,reviewedAt:n.EK.now()}),await r.commit()}async function h(t,e,a){let r=(0,i.vq)(),o=(0,n.qs)(r);o.update((0,n.JU)(r,"users",t),{approvalStatus:"rejected",updatedAt:n.EK.now()}),o.update((0,n.JU)(r,"teacherApprovalRequests",t),{status:"rejected",reviewedBy:e,reviewedAt:n.EK.now(),rejectReason:a}),await o.commit()}async function g(t,e,a,r){let o=(0,i.vq)(),s=(0,n.JU)((0,n.hJ)(o,"classes")),u=new Date,d={id:s.id,name:t,grade:r,teacherId:e,teacherName:a,studentIds:[],createdAt:u,updatedAt:u};await (0,n.pl)(s,{...d,createdAt:n.EK.fromDate(u),updatedAt:n.EK.fromDate(u)});let l=(0,n.JU)(o,"users",e),c=await (0,n.QT)(l);if(c.exists()){let t=c.data().classIds||[];await (0,n.r7)(l,{classIds:[...t,s.id],updatedAt:n.EK.now()})}return d}async function m(t){let e=(0,i.vq)(),a=(0,n.IO)((0,n.hJ)(e,"classes"),(0,n.ar)("teacherId","==",t));return(await (0,n.PL)(a)).docs.map(t=>{var e,a;let r=t.data();return{...r,createdAt:(null===(e=r.createdAt)||void 0===e?void 0:e.toDate())||new Date,updatedAt:(null===(a=r.updatedAt)||void 0===a?void 0:a.toDate())||new Date}})}async function L(){let t=(0,i.vq)();return(await (0,n.PL)((0,n.hJ)(t,"classes"))).docs.map(t=>{var e,a;let r=t.data();return{...r,createdAt:(null===(e=r.createdAt)||void 0===e?void 0:e.toDate())||new Date,updatedAt:(null===(a=r.updatedAt)||void 0===a?void 0:a.toDate())||new Date}})}async function D(t,e,a){let o=(0,i.yL)(),s=(0,i.vq)(),u=[];for(let i of a)try{let a="".concat(i.studentNumber,"@student.iswphonics.com"),d=await (0,r.Xb)(o,a,i.password);await (0,r.ck)(d.user,{displayName:i.displayName});let l=new Date,c={uid:d.user.uid,email:a,displayName:i.displayName,role:"student",approvalStatus:"approved",classId:t,teacherId:e,studentNumber:i.studentNumber,createdAt:l,updatedAt:l,lastLoginAt:l};await (0,n.pl)((0,n.JU)(s,"users",d.user.uid),{...c,createdAt:n.EK.fromDate(l),updatedAt:n.EK.fromDate(l),lastLoginAt:n.EK.fromDate(l)}),u.push(d.user.uid)}catch(t){console.error("학생 생성 실패: ".concat(i.displayName),t)}if(u.length>0){let e=(0,n.JU)(s,"classes",t),a=await (0,n.QT)(e);if(a.exists()){let t=a.data();await (0,n.r7)(e,{studentIds:[...t.studentIds||[],...u],updatedAt:n.EK.now()})}}return u}async function q(t){let e=(0,i.vq)(),a=(0,n.IO)((0,n.hJ)(e,"users"),(0,n.ar)("classId","==",t),(0,n.ar)("role","==","student"));return(await (0,n.PL)(a)).docs.map(t=>{var e,a,r;let n=t.data();return{...n,createdAt:(null===(e=n.createdAt)||void 0===e?void 0:e.toDate())||new Date,updatedAt:(null===(a=n.updatedAt)||void 0===a?void 0:a.toDate())||new Date,lastLoginAt:(null===(r=n.lastLoginAt)||void 0===r?void 0:r.toDate())||new Date}})}async function I(t){let e=(0,i.vq)(),a=(0,n.IO)((0,n.hJ)(e,"users"),(0,n.ar)("role","==",t));return(await (0,n.PL)(a)).docs.map(t=>{var e,a,r;let n=t.data();return{...n,createdAt:(null===(e=n.createdAt)||void 0===e?void 0:e.toDate())||new Date,updatedAt:(null===(a=n.updatedAt)||void 0===a?void 0:a.toDate())||new Date,lastLoginAt:(null===(r=n.lastLoginAt)||void 0===r?void 0:r.toDate())||new Date}})}async function E(t){let e=(0,i.vq)(),a=(0,n.IO)((0,n.hJ)(e,"users"),(0,n.ar)("classId","==",t),(0,n.ar)("role","==","student")),r=await (0,n.PL)(a),o=[];for(let a of r.docs){let r=a.data(),i=await (0,n.QT)((0,n.JU)(e,"userStats",a.id));if(i.exists()){var s;let e=i.data();o.push({oderId:a.id,displayName:r.displayName,classId:t,totalXp:e.totalXp||0,level:e.level||1,currentStreak:e.currentStreak||0,longestStreak:e.longestStreak||0,totalWordsLearned:e.totalWordsLearned||0,totalSessionsCompleted:e.totalSessionsCompleted||0,totalTimeSpentMinutes:e.totalTimeSpentMinutes||0,lastStudyDate:(null===(s=e.lastStudyDate)||void 0===s?void 0:s.toDate())||new Date,weeklyProgress:e.weeklyProgress||[]})}else o.push({oderId:a.id,displayName:r.displayName,classId:t,totalXp:0,level:1,currentStreak:0,longestStreak:0,totalWordsLearned:0,totalSessionsCompleted:0,totalTimeSpentMinutes:0,lastStudyDate:new Date,weeklyProgress:[]})}return o}},91:function(t,e,a){a.d(e,{t:function(){return u}});var r=a(9625),n=a(6885),i=a(2148),o=a(6410),s=a(9804);let u=(0,r.Ue)()((0,n.tJ)((t,e)=>({user:null,firebaseUser:null,isLoading:!0,isInitialized:!1,error:null,get isAuthenticated(){return!!e().user},get isSuperAdmin(){var a;return(null===(a=e().user)||void 0===a?void 0:a.role)==="superAdmin"},get isTeacher(){var r;return(null===(r=e().user)||void 0===r?void 0:r.role)==="teacher"},get isStudent(){var n;return(null===(n=e().user)||void 0===n?void 0:n.role)==="student"},get isApproved(){var u;return(null===(u=e().user)||void 0===u?void 0:u.approvalStatus)==="approved"},initialize:async()=>{let e=(0,o.yL)();return new Promise(a=>{(0,i.Aj)(e,async e=>{if(e)try{let a=await (0,s.et)(e.uid);t({firebaseUser:e,user:a,isLoading:!1,isInitialized:!0})}catch(e){console.error("사용자 프로필 로드 실패:",e),t({firebaseUser:null,user:null,isLoading:!1,isInitialized:!0,error:"사용자 정보를 불러오는데 실패했습니다."})}else t({firebaseUser:null,user:null,isLoading:!1,isInitialized:!0});a()})})},signUp:async(e,a,r,n,i)=>{t({isLoading:!0,error:null});try{let o=await (0,s.Yb)(e,a,r,n,i);t({user:o,isLoading:!1})}catch(a){let e="회원가입에 실패했습니다.";throw"auth/email-already-in-use"===a.code?e="이미 사용 중인 이메일입니다.":"auth/weak-password"===a.code?e="비밀번호가 너무 약합니다. 6자 이상 입력해주세요.":"auth/invalid-email"===a.code&&(e="유효하지 않은 이메일 형식입니다."),t({isLoading:!1,error:e}),Error(e)}},signIn:async(e,a)=>{t({isLoading:!0,error:null});try{let r=await (0,s.Ry)(e,a);t({user:r,isLoading:!1})}catch(a){let e="로그인에 실패했습니다.";throw"auth/user-not-found"===a.code||"auth/wrong-password"===a.code?e="이메일 또는 비밀번호가 올바르지 않습니다.":"auth/too-many-requests"===a.code&&(e="로그인 시도가 너무 많습니다. 잠시 후 다시 시도해주세요."),t({isLoading:!1,error:e}),Error(e)}},signInGoogle:async()=>{t({isLoading:!0,error:null});try{let e=await (0,s.qj)();t({user:e,isLoading:!1})}catch(a){let e="Google 로그인에 실패했습니다.";throw"auth/popup-closed-by-user"===a.code&&(e="로그인이 취소되었습니다."),t({isLoading:!1,error:e}),Error(e)}},signOut:async()=>{t({isLoading:!0,error:null});try{await (0,s.ni)(),t({user:null,firebaseUser:null,isLoading:!1})}catch(e){throw t({isLoading:!1,error:"로그아웃에 실패했습니다."}),e}},sendPasswordReset:async e=>{t({isLoading:!0,error:null});try{await (0,s.c0)(e),t({isLoading:!1})}catch(a){let e="비밀번호 재설정 이메일 발송에 실패했습니다.";throw"auth/user-not-found"===a.code&&(e="해당 이메일로 등록된 계정이 없습니다."),t({isLoading:!1,error:e}),Error(e)}},updateProfile:async a=>{let{user:r}=e();if(r){t({isLoading:!0,error:null});try{await (0,s.Lj)(r.uid,a),t({user:{...r,...a},isLoading:!1})}catch(e){throw t({isLoading:!1,error:"프로필 업데이트에 실패했습니다."}),e}}},clearError:()=>{t({error:null})},refreshUser:async()=>{let{user:a}=e();if(a)try{let e=await (0,s.et)(a.uid);e&&t({user:e})}catch(t){console.error("사용자 정보 새로고침 실패:",t)}}}),{name:"phonics-quest-auth",storage:(0,n.FL)(()=>localStorage),partialize:t=>({})}))}}]);